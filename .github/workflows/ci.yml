name: Build & Deploy Forex Spread Bot

on:
  push:
    branches: [ "main" ]
    paths:
      - "src/**"
      - "k8s/**"
      - "Containerfile"
      - ".github/workflows/ci.yml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_BASE: ghcr.io/ryan801/forex_spread_trading

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ryan801
          password: ${{ secrets.GHCR_PAT }}

      - name: Build and push image
        run: |
          TS="$(date +%Y%m%d-%H%M)"
          SHA="$(git rev-parse --short HEAD)"
          VERSION_TAG="${TS}-${SHA}"

          docker build -f Containerfile -t "${IMAGE_BASE}:latest" .
          docker tag "${IMAGE_BASE}:latest" "${IMAGE_BASE}:${VERSION_TAG}"

          docker push "${IMAGE_BASE}:latest"
          docker push "${IMAGE_BASE}:${VERSION_TAG}"

      - name: Login to OpenShift
        run: |
          oc login "${{ secrets.OCP_API_URL }}" \
            --token="${{ secrets.OCP_TOKEN }}" \
            --insecure-skip-tls-verify=true

      - name: Apply manifests and restart deployment
        run: |
          oc apply -f k8s/spread-trading-configmap.yaml -n forex-spread-trading
          oc apply -f k8s/spread-trading-secret.yaml -n forex-spread-trading
          oc apply -f k8s/spread-trading-deployment.yaml -n forex-spread-trading
          oc rollout restart deployment/forex-spread-trading -n forex-spread-trading
