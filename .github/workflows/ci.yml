name: Build & Deploy Forex Spread Bot

on:
  push:
    branches: [ "main" ]
    paths:
      - "src/**"
      - "k8s/**"
      - "Containerfile"
      - ".github/workflows/ci.yml"

jobs:
  build-and-deploy:
    runs-on: [self-hosted, crc]

    env:
      IMAGE_BASE: ghcr.io/ryan801/forex_spread_trading

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        run: |
          podman login ghcr.io -u ryan801 -p "${{ secrets.GHCR_PAT }}"

      - name: Build and push image
        run: |
          TS="$(date +%Y%m%d-%H%M)"
          SHA="$(git rev-parse --short HEAD)"
          VERSION_TAG="${TS}-${SHA}"

          echo "Building image tag: ${VERSION_TAG}"

          podman build -f Containerfile -t "${IMAGE_BASE}:latest" .
          podman tag "${IMAGE_BASE}:latest" "${IMAGE_BASE}:${VERSION_TAG}"

          podman push "${IMAGE_BASE}:latest"
          podman push "${IMAGE_BASE}:${VERSION_TAG}"
      
      - name: Install oc CLI
        uses: redhat-actions/oc-installer@v1
        with:
          oc_version: 'latest'

      - name: Show oc version (debug)
        run: oc version --client

      - name: Login to OpenShift
        run: |
          oc login "${{ secrets.OCP_API_URL }}" \
            --token="${{ secrets.OCP_TOKEN }}" \
            --insecure-skip-tls-verify=true

      - name: Apply manifests and restart deployment
        run: |
          oc apply -f k8s/spread-trading-configmap.yaml -n forex-spread-trading
          oc apply -f k8s/spread-trading-secret.yaml -n forex-spread-trading
          oc apply -f k8s/spread-trading-deployment.yaml -n forex-spread-trading
          oc rollout restart deployment/forex-spread-trading -n forex-spread-trading
